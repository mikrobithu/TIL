:source-highlighter: rouge
:toc:

== etcd


=== separate to another mountpoint

[source,shell]
----
kubectl drain node1 --delete-emptydir-data --ignore-daemonsets
kubectl get no
rke2-killall.sh
fdisk -l
parted /dev/sdX
mklabel msdos
mkpart primary 0% 100%
mkfs.xfs -L etcd /dev/sdX1
cd /var/lib/rancher/rke2/server/db/
mv etcd etcd_
mkdir etcd
blkid | grep etcd
blkid | grep etcd | cut -d' ' -f3
echo 'UUID="4c392b90-b2f3-48c1-a055-45ac1" /var/lib/rancher/rke2/server/db/etcd  xfs defaults 0 0' >> /etc/fstab
mount -a
chown etcd:etcd /var/lib/rancher/rke2/server/db/etcd
ls -lad /var/lib/rancher/rke2/server/db/etcd
rsync -avz etcd_/ etcd/
find etcd_
find etcd
diff <(find etcd -printf '%f\n'|sort) <(find etcd_ -printf '%f\n'|sort)
systemctl start rke2-server
kubectl uncordon node1
----

[source,shell]
----
mv /var/lib/rancher/rke2/server/db/etcd/ /var/lib/rancher/rke2/server/db/etcd_
mkdir /var/lib/rancher/rke2/server/db/etcd/
fdisk -l | grep '10 GiB' | cut -d ' ' -f2 | cut -d':' -f1

parted --script /dev/sdb mklabel gpt mkpart primary 0% 100%
sleep 3
mkfs.xfs -L etcd /dev/sdb1
blkid /dev/sdb1
 
echo 'LABEL="etcd" /var/lib/rancher/rke2/server/db/etcd xfs  defaults  0  2' >> /etc/fstab
mount -a
mount | grep etcd
df -h | grep etcd


rsync -avz /var/lib/rancher/rke2/server/db/etcd_/ /var/lib/rancher/rke2/server/db/etcd
df -h | grep etcd

systemctl start rke2-server.service

kubectl -n kube-system get po | grep etc

export CRI_CONFIG_FILE=/var/lib/rancher/rke2/agent/etc/crictl.yaml
etcdcontainer=$(/var/lib/rancher/rke2/bin/crictl ps --label io.kubernetes.container.name=etcd --quiet)
/var/lib/rancher/rke2/bin/crictl exec $etcdcontainer etcdctl --cert /var/lib/rancher/rke2/server/tls/etcd/server-client.crt --key /var/lib/rancher/rke2/server/tls/etcd/server-client.key --cacert /var/lib/rancher/rke2/server/tls/etcd/server-ca.crt endpoint health --cluster --write-out=table

----
